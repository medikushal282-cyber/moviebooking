<!DOCTYPE html>
<html lang="en" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Select Showtime – ReelRush Cinematics</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0a0a0f, #1a0b1f);
            color: #e6eef6;
            min-height: 100vh;
            margin: 0;
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #a099d8, #cf30aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>

<body>
    <custom-navbar></custom-navbar>
    <main class="container mx-auto px-4 py-8">
        <h1 class="section-title text-center">Select Showtime</h1>

        <div id="loading" class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto"></div>
            <p class="mt-4 text-gray-400">Loading showtimes...</p>
        </div>

        <div id="content" class="hidden max-w-4xl mx-auto">
            <div class="flex flex-col md:flex-row gap-8 mb-8">
                <div class="md:w-1/3">
                    <img id="movie-poster" src="" alt="Movie Poster" class="w-full rounded-lg shadow-lg">
                </div>
                <div class="md:w-2/3">
                    <h2 id="movie-title" class="text-3xl font-bold mb-2"></h2>
                    <p id="movie-genre" class="text-gray-400 mb-4"></p>
                </div>
            </div>

            <div id="showtimes-grid" class="flex flex-col gap-6">
                <!-- Showtimes injected here -->
            </div>
        </div>
    </main>
    <custom-footer></custom-footer>
    <script src="js/api.js"></script>
    <script src="components/navbar.js"></script>
    <script src="components/footer.js"></script>
    <script>
        if (window.feather) feather.replace();

        const urlParams = new URLSearchParams(window.location.search);
        const movieTitle = urlParams.get('movie');
        const theatreName = urlParams.get('theatre');

        async function init() {
            if (!movieTitle) {
                alert('No movie specified');
                window.location.href = 'index.html';
                return;
            }

            try {
                // 1. Search for the movie to get ID
                const searchRes = await fetch(`${API_BASE_URL}/movies/search?q=${encodeURIComponent(movieTitle)}`);
                const searchData = await searchRes.json();

                if (!searchData.success || searchData.results.length === 0) {
                    throw new Error('Movie not found');
                }

                const movie = searchData.results[0]; // Take best match
                renderMovieInfo(movie);

                // 2. Fetch showtimes for this movie
                const showtimesRes = await fetch(`${API_BASE_URL}/showtimes/movie/${movie._id}`);
                const showtimesData = await showtimesRes.json();

                if (!showtimesData.success) throw new Error(showtimesData.error);

                renderShowtimes(showtimesData.data, theatreName);

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }

        function renderMovieInfo(movie) {
            document.getElementById('movie-title').textContent = movie.title;
            document.getElementById('movie-genre').textContent = `${movie.genre} • ${movie.language} • ${movie.duration} min`;

            const posterPath = movie.img || movie.poster;
            if (posterPath) document.getElementById('movie-poster').src = posterPath;
        }

        function renderShowtimes(showtimes, preselectedTheatre) {
            const grid = document.getElementById('showtimes-grid');

            grid.innerHTML = '';

            // Group showtimes by theatre
            const theatreGroups = {};
            showtimes.forEach(s => {
                const tName = s.theatre.name;
                if (!theatreGroups[tName]) {
                    theatreGroups[tName] = {
                        details: s.theatre,
                        shows: []
                    };
                }
                theatreGroups[tName].shows.push(s);
            });

            if (Object.keys(theatreGroups).length === 0) {
                grid.innerHTML = '<p class="text-center text-gray-400">No showtimes available.</p>';
                return;
            }

            // Render Theatre Cards
            Object.values(theatreGroups).forEach(group => {
                const theatre = group.details;
                const shows = group.shows.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

                const card = document.createElement('div');
                card.className = 'bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg p-6';

                // Theatre Header
                const header = document.createElement('div');
                header.className = 'flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b border-gray-700 pb-4';
                header.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold text-white">${theatre.name}</h3>
                        <p class="text-sm text-gray-400">${theatre.location}</p>
                    </div>
                    <div class="mt-2 md:mt-0">
                        <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">M-Ticket Available</span>
                        <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300 ml-2">F&B</span>
                    </div>
                `;
                card.appendChild(header);

                // Showtimes Container
                const showsContainer = document.createElement('div');
                showsContainer.className = 'flex flex-wrap gap-3';

                shows.forEach(showtime => {
                    const date = new Date(showtime.startTime);
                    const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    const btn = document.createElement('button');
                    btn.className = 'px-4 py-2 rounded border border-green-500 text-green-400 hover:bg-green-500 hover:text-white transition-colors text-sm font-medium';
                    btn.innerHTML = `${timeStr}<br><span class="text-[10px] opacity-75">Screen ${showtime.screen}</span>`;

                    btn.onclick = () => {
                        window.location.href = `select-seats.html?id=${showtime._id}`;
                    };

                    showsContainer.appendChild(btn);
                });

                card.appendChild(showsContainer);
                grid.appendChild(card);
            });
        }

        init();
    </script>
</body>

</html>